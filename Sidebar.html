<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Malgun Gothic', sans-serif; padding: 12px; color: #333; font-size: 12px; max-width: 300px; box-sizing: border-box; }
      * { box-sizing: border-box; }
      .input-group { margin-bottom: 8px; }
      label { display: block; margin-bottom: 2px; font-weight: bold; font-size: 12px; }
      input, select, textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
      .btn { width: 100%; padding: 8px 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 4px; font-size: 12px; }
      .btn-blue { background-color: #1a73e8; }
      .btn-gray { background-color: #5f6368; }
      .btn-green { background-color: #34a853; }
      .btn-red { background-color: #d93025; margin-top: 16px; }
      .tab-container { display: flex; margin-bottom: 12px; border-bottom: 1px solid #ddd; gap: 8px; }
      .tab { padding: 6px 12px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 12px; }
      .tab.active { border-bottom: 2px solid #1a73e8; font-weight: bold; color: #1a73e8; }
      #preview { margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; min-height: 18px; font-size: 12px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; }
      #preview.preview-error { color: #d93025; }
      /* 인용 검사 리스트 박스 크기 확대 */
      .scan-list-box {
        max-height: 400px !important; /* 300px에서 400px로 확대 */
        min-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 6px;
        background: #fafafa;
        margin-bottom: 12px;
      }
      .scan-list-box.section-unverified { background: #fff8f8; border-color: #e0e0e0; }
      .dummy-item { margin-bottom: 2px; padding: 2px 4px; background: white; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px; line-height: 1.3; min-height: 0; }
      .dummy-item .dummy-text { font-weight: bold; color: #1a73e8; margin-bottom: 2px; font-size: 11px; }
      .dummy-item .score-tag { font-size: 10px; color: #666; font-weight: normal; margin-left: 4px; }
      .section-title { font-size: 12px; font-weight: bold; margin: 8px 0 4px 0; color: #333; }
      .section-unverified .section-title { color: #d93025; }
      .warn-tag { font-size: 10px; color: #d93025; background: #fce8e6; padding: 2px 6px; border-radius: 3px; margin-left: 6px; }
      .dummy-item select { margin-top: 2px; font-size: 11px; padding: 2px 4px; width: 100%; min-height: 26px; }
      /* 서식 설정 탭의 체크박스 행 개선 */
      .checkbox-row {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        gap: 8px !important;
        margin-bottom: 10px !important;
        width: 100% !important;
        white-space: normal !important; /* 텍스트가 너무 길면 다음 줄로 자연스럽게 넘어가게 함 */
      }

      .checkbox-row input[type="checkbox"] {
        flex-shrink: 0 !important; /* 체크박스 크기 고정 */
        width: 16px !important;
        height: 16px !important;
      }

      .checkbox-row label {
        font-size: 12px !important;
        line-height: 1.2 !important;
        cursor: pointer;
        flex: 1; /* 남은 공간 차지 */
        overflow: visible !important; /* 텍스트가 잘리지 않게 함 */
      }
      select { width: 100%; min-width: 0; min-height: 32px; padding: 6px 24px 6px 8px; appearance: auto; font-size: 12px; }
      #styleEntry .input-group { min-width: 0; }
      #styleEntry select { width: 100%; box-sizing: border-box; }
      /* 페이지 라벨 한 줄: 라벨 좌측, p./pp. 토글 우측 */
      .page-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .page-label-row > label {
        margin-bottom: 0;
      }

      .page-toggle-inline {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .page-toggle-inline input[type="checkbox"] {
        width: 13px;
        height: 13px;
        margin: 0;
        flex-shrink: 0;
      }

      .page-toggle-inline label {
        margin: 0;
        font-size: 11px;
        font-weight: normal;
        white-space: nowrap;
        cursor: pointer;
      }
      /* 서식 설정 탭 버튼 그룹·간격 */
      .style-btn-group { margin-top: 12px; }
      .style-btn-group .btn { margin-top: 8px; }
      .style-btn-group .btn:first-child { margin-top: 0; }
      .style-btn-sep { margin-top: 16px; padding-top: 12px; border-top: 1px solid #ddd; }
      .style-btn-sep .btn { margin-top: 8px; }
      /* 저장된 문헌 리스트 (체크박스) */
      .citation-list-box {
        max-height: 220px; overflow-y: auto; border: 1px solid #ddd; padding: 6px; background: #fafafa; margin: 8px 0 10px 0; border-radius: 4px;
      }
      .citation-list-item { display: flex; align-items: flex-start; gap: 6px; margin-bottom: 6px; font-size: 11px; line-height: 1.3; }
      .citation-list-item input[type="checkbox"] { flex-shrink: 0; margin-top: 2px; width: 14px; height: 14px; cursor: pointer; }
      .citation-list-item label { cursor: pointer; flex: 1; margin: 0; font-weight: normal; }
    </style>
  </head>
  <body>
    <div class="input-group" style="margin-bottom: 10px;">
      <label for="styleSelect">인용 스타일</label>
      <select id="styleSelect" onchange="handleStyleChange()">
        <option value="APA">APA 7th</option>
        <option value="MLA">MLA 9th</option>
        <option value="KCI">국문 학술지</option>
      </select>
    </div>
    <div class="tab-container">
      <div id="tab1" class="tab active" onclick="switchTab(1)" data-i18n="ui.tabs.manual">직접 입력</div>
      <div id="tab2" class="tab" onclick="switchTab(2)" data-i18n="ui.tabs.paste">통째로 붙여넣기</div>
      <div id="tab3" class="tab" onclick="switchTab(3)" data-i18n="ui.tabs.scan">인용 검사</div>
      <div id="tab4" class="tab" onclick="switchTab(4)" data-i18n="ui.tabs.style">서식 설정</div>
    </div>

    <div id="manualEntry">
      <div class="input-group">
        <label data-i18n="ui.manual.title">논문/도서 제목</label>
        <input type="text" id="title" data-i18n-placeholder="placeholders.title" placeholder="제목을 입력하세요">
      </div>
      <div class="input-group">
        <label data-i18n="ui.manual.author">저자 (세미콜론 ';'으로 구분)</label>
        <input type="text" id="author" data-i18n-placeholder="placeholders.author" placeholder="Li, A; Smith, B">
      </div>
      <div class="input-group">
        <label data-i18n="ui.manual.publisher">출판사 / 학회 / 저널명</label>
        <input type="text" id="publisher" data-i18n-placeholder="placeholders.publisher" placeholder="출판 정보">
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label data-i18n="ui.manual.volume">권 (Volume)</label>
          <input type="text" id="volume" data-i18n-placeholder="placeholders.volume" placeholder="25">
        </div>
        <div style="flex: 1;">
          <label data-i18n="ui.manual.issue">호 (Issue)</label>
          <input type="text" id="issue" data-i18n-placeholder="placeholders.issue" placeholder="6">
        </div>
      </div>
      <div class="input-group">
        <div class="page-label-row">
          <label for="page" data-i18n="ui.manual.page">페이지 (Page)</label>
          <span class="page-toggle-inline">
            <input type="checkbox" id="korUsePagePrefixManual">
            <label for="korUsePagePrefixManual" data-i18n="ui.manual.pagePrefix">p./pp. 표시</label>
          </span>
        </div>
        <input type="text" id="page" data-i18n-placeholder="placeholders.page" placeholder="10-25 또는 110-120">
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label data-i18n="ui.manual.year">연도</label>
          <input type="text" id="year" data-i18n-placeholder="placeholders.year" placeholder="2024">
        </div>
        <div style="flex: 1;">
          <label data-i18n="ui.manual.style">양식</label>
          <select id="style">
            <option value="APA" data-i18n="ui.style.presetAPA">APA</option>
            <option value="MLA" data-i18n="ui.style.presetMLA">MLA</option>
          </select>
        </div>
      </div>
    </div>

    <div id="pasteEntry" style="display: none;">
      <div class="input-group">
        <label for="shortCit" data-i18n="ui.paste.shortLabel">본문 인용구 제안 (수정 가능)</label>
        <input type="text" id="shortCit" data-i18n-placeholder="placeholders.shortCit" placeholder="예: (Smith, 2024)">
      </div>
      <div class="input-group">
        <label for="fullPaste" data-i18n="ui.paste.fullLabel">전체 참고문헌 정보 (Full)</label>
        <textarea id="fullPaste" rows="5" data-i18n-placeholder="placeholders.fullPaste" placeholder="전체 내용을 붙여넣으세요."></textarea>
        <button type="button" class="btn btn-blue" onclick="analyzeCitation()" style="margin-top: 6px;" data-i18n="ui.paste.analyzeBtn">지능형 분석 및 인용구 생성</button>
      </div>
      <div class="input-group" id="pasteYearWrap">
        <label for="pasteYear" data-i18n="ui.paste.yearLabel">연도 (분석 결과)</label>
        <input type="text" id="pasteYear" data-i18n-placeholder="placeholders.pasteYear" placeholder="분석 후 자동 입력" readonly style="background: #f0f0f0;">
      </div>
    </div>

    <div id="styleEntry" style="display: none;">
      <p id="styleDesc" style="font-size: 11px; color: #666; margin-bottom: 8px;">참고문헌 목록의 학회별 세부 서식(Style Settings)을 설정합니다.</p>
      <div class="input-group" style="margin-bottom: 10px;">
        <label>스타일 세부설정</label>
        <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;">위의 <strong>인용 스타일</strong>을 선택한 뒤, 아래 옵션으로 세부사항(쉼표, 이탤릭, 앰퍼샌드 등)을 조정합니다.</p>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="italicsTitle" checked>
        <label for="italicsTitle" data-i18n="ui.style.italicsTitle">논문/도서 제목 이탤릭체</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="italicsJournal" checked>
        <label for="italicsJournal" data-i18n="ui.style.italicsJournal">저널명 이탤릭체</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="korItalicsJournal">
        <label for="korItalicsJournal" data-i18n="ui.style.korItalicsJournal">국문 저널명 이탤릭체</label>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label data-i18n="ui.style.authorSeparator">저자 구분자</label>
          <select id="authorSeparator" style="width: 100%;">
            <option value=", " data-i18n="ui.style.separatorComma">, (쉼표)</option>
            <option value=" & " data-i18n="ui.style.separatorAmp">& (앰퍼샌드)</option>
            <option value="; " data-i18n="ui.style.separatorSemi">; (세미콜론)</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label data-i18n="ui.style.etAlThreshold">et al./외 기준 (인)</label>
          <input type="number" id="etAlThreshold" min="2" max="10" value="3" style="width: 100%;">
        </div>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label data-i18n="ui.style.lineSpacing">줄 간격 (pt)</label>
          <input type="number" id="lineSpacing" min="0" max="36" value="12" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label data-i18n="ui.style.hangingIndent">매달린 들여쓰기 (pt)</label>
          <input type="number" id="hangingIndent" min="0" max="72" value="20" style="width: 100%;">
        </div>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label data-i18n="ui.style.indentFirstLine">첫 줄 들여쓰기 (pt)</label>
          <input type="number" id="indentFirstLine" min="0" max="72" value="0" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label data-i18n="ui.style.headerFontSize">헤더 글꼴 크기</label>
          <input type="number" id="headerFontSize" min="8" max="24" value="14" style="width: 100%;">
        </div>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label data-i18n="ui.style.headerAlignment">헤더 정렬</label>
          <select id="headerAlignment" style="width: 100%;">
            <option value="LEFT" data-i18n="ui.style.alignLeft">왼쪽</option>
            <option value="CENTER" data-i18n="ui.style.alignCenter">가운데</option>
            <option value="RIGHT" data-i18n="ui.style.alignRight">오른쪽</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label data-i18n="ui.style.yearBracket">연도 괄호</label>
          <select id="yearBracket" style="width: 100%;">
            <option value="()" data-i18n="ui.style.bracketParen">( )</option>
            <option value="[]" data-i18n="ui.style.bracketSquare">[ ]</option>
            <option value="none" data-i18n="ui.style.bracketNone">없음</option>
          </select>
        </div>
      </div>
      <div class="style-btn-group">
        <button class="btn btn-blue" onclick="handleSaveStyle()" data-i18n="ui.style.saveStyle">설정 저장</button>
        <button class="btn btn-green" onclick="handleGenerate()" data-i18n="ui.common.generateBibliography">참고문헌 목록 생성</button>
        <button class="btn btn-green" onclick="handleSort()" data-i18n="ui.style.btn_sort">참고문헌 정렬 및 서식 적용</button>
        <button class="btn btn-gray" onclick="handleFinalize()" data-i18n="ui.style.btn_finalize">최종본 전환</button>
      </div>
      <div class="style-btn-sep style-btn-group">
        <button class="btn btn-red" onclick="handleClear()" data-i18n="ui.common.clearAll">데이터 전체 초기화</button>
      </div>
    </div>

    <div id="scanEntry" style="display: none;">
      <p id="scanDesc" style="font-size: 11px; color: #666; margin-bottom: 10px;" data-i18n="ui.scan.description">문서 내 임시 인용을 감지하고 실제 문헌과 연결합니다.</p>
      <button class="btn btn-blue" onclick="handleScan()" style="margin-bottom: 10px;" data-i18n="ui.scan.scanBtn">문서 스캔</button>
      <div id="scanResults" style="display: none;">
        <div id="recommendedSection" style="margin-bottom: 10px;"></div>
        <div id="unverifiedSection" class="section-unverified" style="margin-bottom: 10px;"></div>
        <button class="btn btn-green" onclick="handleApplyMapping()" data-i18n="ui.scan.applyMapping">매핑 적용</button>
      </div>
    </div>

    <p id="insertHint" style="font-size: 11px; color: #666; margin: 8px 0 0 0;" data-i18n="ui.common.insertHint">삽입 위치: 본문에서 원하는 곳을 클릭한 뒤 버튼을 누르세요.</p>
    <div id="citationListSection" style="display: none;">
      <div id="citationListBox" class="citation-list-box"></div>
      <button type="button" class="btn btn-blue" id="btnMultiInsert" onclick="handleMultiInsert()" style="margin-bottom: 4px;" data-i18n="ui.paste.btn_multi_insert">선택된 문헌들 일괄 삽입</button>
      <p id="multiCitationWrapHint" style="font-size: 11px; color: #666; margin: 0 0 8px 0;" data-i18n="ui.paste.multiCitationWrapHint">3개 이상 인용 시 본문이 길어져 줄바꿈이 될 수 있습니다.</p>
    </div>
    <div id="entryButtons" style="display: flex; gap: 5px; margin-top: 10px;">
      <button class="btn btn-blue" onclick="handleEntry('insert')" style="flex: 2;" data-i18n="ui.common.insertAndSave">본문에 삽입 및 저장</button>
      <button class="btn btn-gray" onclick="handleEntry('save')" style="flex: 1;" data-i18n="ui.common.saveOnly">저장만 하기</button>
    </div>
    <div id="commonBibButtons" style="margin-top: 10px;">
      <button class="btn btn-green" onclick="handleGenerate()" data-i18n="ui.common.generateBibliography">참고문헌 목록 생성</button>
      <button class="btn btn-blue" onclick="handleRefreshAllCitations()" style="margin-top: 6px;">인용 일괄 변환</button>
      <button class="btn btn-red" onclick="handleClear()" data-i18n="ui.common.clearAll" style="margin-top: 6px;">데이터 전체 초기화</button>
    </div>
    <p id="permissionHint" style="font-size: 10px; color: #888; margin-top: 8px;" data-i18n="ui.common.permissionHint">처음 사용 시 권한 허용 창이 뜨면 허용해 주세요.</p>
    <div id="preview" data-i18n="ui.common.previewWaiting">알림: 대기 중...</div>

    <script>
      var scanData = null;
      var citationListData = [];
      var LANG_PACK = {};

      function t(key) {
        if (!key || !LANG_PACK) return key;
        var keys = key.split('.');
        var v = LANG_PACK;
        for (var i = 0; i < keys.length; i++) { v = v ? v[keys[i]] : undefined; }
        return v != null ? String(v) : key;
      }

      function formatMsg(template, params) {
        if (!template) return '';
        var s = String(template);
        if (!params) return s;
        for (var k in params) { if (params.hasOwnProperty(k)) s = s.replace(new RegExp('\\{' + k + '\\}', 'g'), String(params[k])); }
        return s;
      }

      function applyI18n() {
        document.querySelectorAll('[data-i18n]').forEach(function(el) {
          var key = el.getAttribute('data-i18n');
          var val = t(key);
          if (val) el.textContent = val;
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
          var key = el.getAttribute('data-i18n-placeholder');
          var val = t(key);
          if (val) el.placeholder = val;
        });
      }

      function loadSettings() {
        google.script.run.withSuccessHandler(function(result) {
          try {
            result = typeof result === 'string' ? JSON.parse(result) : result;
          } catch (e) { result = {}; }
          var style = (result && result.citationStyle) ? result.citationStyle : (result || 'APA');
          var sel = document.getElementById('styleSelect');
          if (sel && (style === 'APA' || style === 'MLA' || style === 'KCI')) sel.value = style;
        }).withFailureHandler(function() {}).getStyleConfig();
      }
      function handleStyleChange() {
        var sel = document.getElementById('styleSelect');
        if (!sel) return;
        var style = sel.value;
        document.getElementById('preview').innerText = '⏳ 스타일 저장 중...';
        google.script.run.withSuccessHandler(function() {
          document.getElementById('preview').innerText = '✅ 스타일이 저장되었습니다. 해당 스타일 기본값이 세부설정에 반영됩니다.';
          loadStyleConfig();
        }).withFailureHandler(function(err) {
          document.getElementById('preview').innerText = '❌ 저장 실패: ' + (err && (err.message || err)) || '';
        }).saveStyleSetting(style);
      }
      (function initI18n() {
        google.script.run.withSuccessHandler(function(pack) {
          LANG_PACK = pack || {};
          applyI18n();
          loadCitationList();
          loadSettings();
        }).withFailureHandler(function() {
          LANG_PACK = {};
          applyI18n();
          loadCitationList();
          loadSettings();
        }).getLanguagePack();
      })();

      function getCitationItemLabel(item, noTitle) {
        if (!item) return '';
        if (item.mode === 'manual') {
          var author = (item.authorRaw || item.author || '').trim();
          var year = (item.secondVal || '').trim();
          var title = (item.title || '').trim();
          return '[' + (author ? author + (year ? ' (' + year + ')' : '') : '') + '] ' + (title ? title.substring(0, 50) + (title.length > 50 ? '\u2026' : '') : (noTitle || '(제목 없음)'));
        } else {
          var short = (item.shortText || '').trim();
          var full = (item.fullText || '').trim();
          return short ? '[' + short + '] ' + (full ? full.substring(0, 55) + (full.length > 55 ? '\u2026' : '') : '') : (full ? full.substring(0, 80) + (full.length > 80 ? '\u2026' : '') : '(내용 없음)');
        }
      }

      function loadCitationList() {
        var box = document.getElementById('citationListBox');
        if (!box) return;
        google.script.run.withSuccessHandler(function(result) {
          try {
            result = typeof result === 'string' ? JSON.parse(result) : result;
          } catch (e) {
            result = { ok: false };
          }
          citationListData = (result && result.list) ? result.list : [];
          if (citationListData.length === 0) {
            box.innerHTML = '<p style="margin:0;font-size:11px;color:#888;">저장된 문헌이 없습니다.</p>';
            return;
          }
          var html = '';
          for (var i = 0; i < citationListData.length; i++) {
            var item = citationListData[i];
            var id = 'cite_cb_' + i;
            var label = getCitationItemLabel(item);
            html += '<div class="citation-list-item"><input type="checkbox" id="' + id + '" data-index="' + i + '"><label for="' + id + '">' + escapeHtml(label) + '</label></div>';
          }
          box.innerHTML = html;
        }).withFailureHandler(function() {
          citationListData = [];
          box.innerHTML = '';
        }).getCitationList();
      }

      function handleMultiInsert() {
        var checked = [];
        document.querySelectorAll('#citationListBox input[type="checkbox"]:checked').forEach(function(cb) {
          var idx = parseInt(cb.getAttribute('data-index'), 10);
          if (!isNaN(idx) && idx >= 0 && idx < citationListData.length) checked.push(citationListData[idx]);
        });
        if (checked.length === 0) {
          alert(t('alerts.requiredFields'));
          return;
        }
        var preview = document.getElementById('preview');
        preview.className = '';
        preview.innerText = t('messages.processing');
        google.script.run.withSuccessHandler(function(result) {
          try { result = typeof result === 'string' ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            preview.className = 'preview-error';
            preview.innerText = t('messages.errorPrefix') + result.error;
            return;
          }
          preview.innerText = formatMsg(t('messages.multiInsertDone'), { count: result.count || checked.length });
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          preview.className = 'preview-error';
          preview.innerText = t('messages.errorPrefix') + msg;
        }).insertMultiCitation(checked);
      }

      function switchTab(num) {
        document.getElementById('manualEntry').style.display = num === 1 ? 'block' : 'none';
        document.getElementById('pasteEntry').style.display = num === 2 ? 'block' : 'none';
        document.getElementById('scanEntry').style.display = num === 3 ? 'block' : 'none';
        document.getElementById('styleEntry').style.display = num === 4 ? 'block' : 'none';
        document.getElementById('tab1').className = num === 1 ? 'tab active' : 'tab';
        document.getElementById('tab2').className = num === 2 ? 'tab active' : 'tab';
        document.getElementById('tab3').className = num === 3 ? 'tab active' : 'tab';
        document.getElementById('tab4').className = num === 4 ? 'tab active' : 'tab';
        var showEntry = (num === 1 || num === 2);
        document.getElementById('insertHint').style.display = showEntry ? 'block' : 'none';
        document.getElementById('citationListSection').style.display = showEntry ? 'block' : 'none';
        document.getElementById('entryButtons').style.display = showEntry ? 'flex' : 'none';
        document.getElementById('commonBibButtons').style.display = num === 4 ? 'none' : 'block';
        if (num === 4) loadStyleConfig();
        if (num === 1) loadStyleConfigForManualTab();
        if (showEntry) loadCitationList();
      }
      function loadStyleConfigForManualTab() {
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          var c = (result && result.config) || {};
          var el = document.getElementById('korUsePagePrefixManual');
          if (el) el.checked = c.korUsePagePrefix === true;
        }).getStyleConfig();
      }

      function loadStyleConfig() {
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          var c = result.config || {};
          var styleSelect = document.getElementById('styleSelect');
          if (styleSelect && (result.citationStyle === 'APA' || result.citationStyle === 'MLA' || result.citationStyle === 'KCI')) styleSelect.value = result.citationStyle;
          document.getElementById('italicsTitle').checked = c.italicsTitle !== false;
          document.getElementById('italicsJournal').checked = c.italicsJournal !== false;
          document.getElementById('korItalicsJournal').checked = c.korItalicsJournal === true;
          var korManual = document.getElementById('korUsePagePrefixManual');
          if (korManual) korManual.checked = c.korUsePagePrefix === true;
          var sep = c.authorSeparator || ', ';
          document.getElementById('authorSeparator').value = (sep === ' & ') ? ' & ' : (sep === '; ') ? '; ' : ', ';
          document.getElementById('etAlThreshold').value = c.etAlThreshold || 3;
          document.getElementById('lineSpacing').value = c.lineSpacing || 12;
          document.getElementById('hangingIndent').value = c.hangingIndent || 20;
          document.getElementById('indentFirstLine').value = c.indentFirstLine || 0;
          document.getElementById('headerFontSize').value = c.headerFontSize || 14;
          document.getElementById('headerAlignment').value = c.headerAlignment || 'CENTER';
          document.getElementById('yearBracket').value = c.yearBracket || '()';
        }).getStyleConfig();
      }

      function handleSaveStyle() {
        var overrides = {
          italicsTitle: document.getElementById('italicsTitle').checked,
          italicsJournal: document.getElementById('italicsJournal').checked,
          korItalicsJournal: document.getElementById('korItalicsJournal').checked,
          korUsePagePrefix: (function(){ var el = document.getElementById('korUsePagePrefixManual'); return el ? el.checked : false; })(),
          authorSeparator: document.getElementById('authorSeparator').value || ', ',
          etAlThreshold: parseInt(document.getElementById('etAlThreshold').value, 10) || 3,
          lineSpacing: parseInt(document.getElementById('lineSpacing').value, 10) || 12,
          hangingIndent: parseInt(document.getElementById('hangingIndent').value, 10) || 20,
          indentFirstLine: parseInt(document.getElementById('indentFirstLine').value, 10) || 0,
          headerFontSize: parseInt(document.getElementById('headerFontSize').value, 10) || 14,
          headerAlignment: document.getElementById('headerAlignment').value || 'CENTER',
          yearBracket: document.getElementById('yearBracket').value || '()'
        };
        document.getElementById('preview').innerText = t('messages.saving');
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          document.getElementById('preview').innerText = result.error ? t('messages.errorPrefix') + result.error : t('messages.styleSaved');
        }).withFailureHandler(function(err) {
          document.getElementById('preview').innerText = t('messages.errorPrefix') + ((err && (err.message || err.error || err)) || String(err));
        }).saveStyleConfig({ overrides: overrides });
      }

      function formatAuthorsForInText(str) {
        if (!str) return "Unknown";
        
        // 국문 여부 판별
        const isKo = /[\uac00-\ud7a3\u4e00-\u9fff]/.test(str);
        
        // 지능형 구분자 분리: 세미콜론이 있으면 세미콜론 우선, 없으면 쉼표로 분리
        let authors = [];
        if (str.indexOf(';') >= 0) {
          authors = str.split(';').map(s => s.trim()).filter(s => s !== "");
        } else if (isKo) {
          authors = str.split(',').map(s => s.trim()).filter(s => s !== "");
        } else {
          authors = [str.trim()];
        }
        
        if (authors.length === 0) return "Unknown";
        if (authors.length === 1) return authors[0];
        
        // 영문 성(Surname) 추출 함수
        const getSurname = (name) => {
          const n = name.split(' ');
          return n[n.length - 1];
        };

        if (isKo) {
          // 국문: 2명은 'A & B', 3명 이상은 'A 외'
          if (authors.length >= 3) return authors[0] + " 외";
          return authors[0] + " & " + authors[1];
        } else {
          // 영문: 3명 이상 'Surname et al.', 2명 'Surname & Surname'
          if (authors.length >= 3) return getSurname(authors[0]) + " et al.";
          return getSurname(authors[0]) + " & " + getSurname(authors[1]);
        }
      }

      /** 지능형 분석: Code.gs의 parseAndSuggestCitation 호출 후 Short·연도 칸 채움. 실패 시 수동 입력 유도 */
      function analyzeCitation() {
        var fullText = (document.getElementById("fullPaste") && document.getElementById("fullPaste").value || "").trim();
        if (!fullText) {
          alert(t('alerts.pasteFullFirst'));
          return;
        }
        var preview = document.getElementById("preview");
        if (preview) preview.innerText = t('messages.analyzing');
        google.script.run
          .withSuccessHandler(function(resultStr) {
            try {
              var result = typeof resultStr === "string" ? JSON.parse(resultStr) : resultStr;
              if (result && result.ok === true) {
                if (document.getElementById("shortCit")) document.getElementById("shortCit").value = result.citationText || "";
                if (document.getElementById("pasteYear")) document.getElementById("pasteYear").value = result.year || "";
                if (preview) preview.innerText = t('messages.analysisDone');
              } else {
                if (preview) preview.innerText = "⚠️ " + (result && result.error ? result.error : t('messages.analysisFailed'));
              }
            } catch (e) {
              if (preview) preview.innerText = "⚠️ " + t('messages.resultError');
            }
          })
          .withFailureHandler(function(err) {
            var msg = err && (err.message || err.error || err) ? (err.message || err.error || err) : String(err);
            if (preview) preview.innerText = t('messages.errorServer') + msg + t('messages.serverErrorPaste');
          })
          .parseAndSuggestCitation(fullText);
      }

      function handleEntry(action) {
        const isManual = document.getElementById('manualEntry').style.display !== 'none';
        const preview = document.getElementById('preview');
        let data = {};

        if (isManual) {
          const title = document.getElementById('title').value;
          const authorInput = (document.getElementById('author').value || '').trim();
          const year = document.getElementById('year').value;
          const publisher = document.getElementById('publisher').value;
          const volume = (document.getElementById('volume').value || '').trim();
          const issue = (document.getElementById('issue').value || '').trim();
          const page = (document.getElementById('page').value || '').trim();
          const style = document.getElementById('style').value;

          if (!title || !authorInput || !year) { alert(t('alerts.requiredFields')); return; }
          const formattedAuthor = formatAuthorsForInText(authorInput);
          preview.innerText = t('messages.processing');
          google.script.run.withSuccessHandler(function(fullText) {
            data = {
              mode: 'manual', title: title, author: formattedAuthor, authorRaw: authorInput, secondVal: year,
              publisher: publisher, volume: volume, issue: issue, page: page, style: style, fullText: fullText,
              korUsePagePrefix: document.getElementById('korUsePagePrefixManual') ? document.getElementById('korUsePagePrefixManual').checked : false
            };
            var runner = google.script.run.withSuccessHandler(function(result) {
              try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
              if (result && result.error) { preview.innerText = t('messages.errorPrefix') + result.error; return; }
              if (action === 'insert') preview.innerText = (result.at === 'cursor') ? t('messages.insertAtCursor') : t('messages.insertAtEnd');
              else preview.innerText = t('messages.saveDone');
              loadCitationList();
              document.getElementById('title').value = ""; document.getElementById('author').value = ""; document.getElementById('year').value = "";
              document.getElementById('publisher').value = ""; document.getElementById('volume').value = ""; document.getElementById('issue').value = ""; document.getElementById('page').value = "";
            }).withFailureHandler(function(err) {
              var msg = (err && (err.message || err.error || err)) || String(err);
              preview.innerText = t('messages.errorServer') + msg;
            });
            if (action === 'insert') runner.insertCitation(data); else runner.saveCitationOnly(data);
          }).withFailureHandler(function(err) {
            preview.innerText = t('messages.errorPrefix') + ((err && (err.message || err.error || err)) || String(err));
          }).getInTextCitationString(authorInput, year, style);
          return;
        } else {
          const shortCit = document.getElementById('shortCit').value;
          const fullText = document.getElementById('fullPaste').value;
          if (!shortCit || !fullText) { alert(t('alerts.enterAllData')); return; }
          data = { mode: 'paste', fullText: fullText.trim(), shortText: shortCit.trim(), title: "Pasted_" + new Date().getTime() };
        }

        preview.innerText = t('messages.processing');
        var runner = google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            preview.innerText = t('messages.errorPrefix') + result.error;
            return;
          }
          if (action === 'insert') {
            if (result && result.at === 'cursor') preview.innerText = t('messages.insertAtCursor');
            else preview.innerText = t('messages.insertAtEnd');
          } else {
            preview.innerText = t('messages.saveDone');
          }
          loadCitationList();
          if (isManual) {
            document.getElementById('title').value = "";
            document.getElementById('author').value = "";
            document.getElementById('year').value = "";
            document.getElementById('publisher').value = "";
            document.getElementById('volume').value = "";
            document.getElementById('issue').value = "";
            document.getElementById('page').value = "";
          }
          else {
            document.getElementById('shortCit').value = "";
            document.getElementById('fullPaste').value = "";
            if (document.getElementById('pasteYear')) document.getElementById('pasteYear').value = "";
          }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          preview.innerText = t('messages.errorServer') + msg;
        });
        if (action === 'insert') runner.insertCitation(data);
        else runner.saveCitationOnly(data);
      }

      function handleGenerate() {
        var preview = document.getElementById('preview');
        preview.className = '';
        preview.innerText = t('messages.generating');
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.ok && result.count > 0) {
            preview.className = '';
            preview.innerText = formatMsg(t('messages.generateDone'), { count: result.count });
          } else if (result && result.error) {
            preview.className = 'preview-error';
            preview.innerText = t('messages.errorPrefix') + result.error;
          } else if (result && result.message) {
            preview.className = '';
            preview.innerText = formatMsg(t('messages.generateNoItems'), { message: result.message });
          } else {
            preview.className = '';
            preview.innerText = t('messages.generateNoData');
          }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          preview.className = 'preview-error';
          preview.innerText = t('messages.errorPrefix') + msg;
        }).generateBibliography();
      }

      function handleRefreshAllCitations() {
        var preview = document.getElementById('preview');
        preview.className = '';
        preview.innerText = '⏳ 인용 일괄 변환 중...';
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.ok) {
            preview.innerText = '✅ ' + (result.replaced || 0) + '개 인용 변환 완료. ' + (result.message || '참고문헌이 최신 스타일로 깔끔하게 재생성되었습니다.');
          } else {
            preview.className = 'preview-error';
            preview.innerText = '❌ ' + (result && result.error ? result.error : '오류가 발생했습니다.');
          }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          document.getElementById('preview').className = 'preview-error';
          document.getElementById('preview').innerText = '❌ ' + msg;
        }).refreshAllCitations();
      }

      function handleClear() {
        if (confirm(t('alerts.confirmClear'))) {
          google.script.run.withSuccessHandler(function() {
            alert(t('alerts.cleared'));
            document.getElementById('preview').innerText = t('messages.clearDone');
            citationListData = [];
            loadCitationList();
            scanData = null;
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('recommendedSection').innerHTML = '';
            document.getElementById('unverifiedSection').innerHTML = '';
          }).withFailureHandler(function(err) {
            var msg = (err && (err.message || err.error || err)) || String(err);
            document.getElementById('preview').innerText = t('messages.errorPrefix') + msg;
          }).clearCitations();
        }
      }

      function handleScan() {
        document.getElementById('preview').innerText = t('messages.scanning');
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            document.getElementById('preview').innerText = t('messages.errorPrefix') + result.error;
            return;
          }
          scanData = result;
          if (!result.dummies || result.dummies.length === 0) {
            document.getElementById('preview').innerText = t('messages.noDummies');
            document.getElementById('scanResults').style.display = 'none';
            return;
          }
          var opts = result.citationOptions || [];
          if (opts.length === 0) {
            document.getElementById('preview').innerText = t('messages.noCitationsForScan');
            document.getElementById('scanResults').style.display = 'none';
            return;
          }
          var recommended = [];
          var unverified = [];
          for (var i = 0; i < result.dummies.length; i++) {
            var d = result.dummies[i];
            d._idx = i;
            if (d.isUnverified) unverified.push(d);
            else recommended.push(d);
          }
          var makeItemHtml = function(d, idx) {
            var recIdx = d.recommendedIndex !== undefined ? d.recommendedIndex : (d.suggestedIndex !== undefined ? d.suggestedIndex : -1);
            var score = d.score !== undefined ? d.score : 0;
            var sel = '<select id="map_' + idx + '" class="citation-select">';
            sel += '<option value="-1">' + t('ui.scan.skip') + '</option>';
            for (var j = 0; j < opts.length; j++) {
              var selected = (recIdx >= 0 && opts[j].index === recIdx) ? ' selected' : '';
              sel += '<option value="' + opts[j].index + '"' + selected + '>' + escapeHtml(opts[j].label || '') + '</option>';
            }
            sel += '</select>';
            var warnTag = d.isUnverified ? '<span class="warn-tag">' + t('ui.scan.needLink') + '</span>' : '';
            var scoreTag = (score > 0 && !d.isUnverified) ? ' <span class="score-tag">' + score + t('ui.scan.points') + '</span>' : '';
            var cb = '<input type="checkbox" class="dummy-include" id="include_' + idx + '" checked>';
            return '<div class="dummy-item" data-index="' + idx + '">' + cb + '<div class="dummy-text">' + escapeHtml(d.text) + scoreTag + warnTag + '</div>' + sel + '</div>';
          };
          var recHtml = recommended.length > 0 ? '<div class="section-title">' + t('ui.scan.recommended') + ' (' + recommended.length + ')</div><div class="scan-list-box">' + recommended.map(function(d) { return makeItemHtml(d, d._idx); }).join('') + '</div>' : '';
          var unvHtml = unverified.length > 0 ? '<div class="section-title">' + t('ui.scan.unverified') + ' (' + unverified.length + ')</div><div class="scan-list-box section-unverified">' + unverified.map(function(d) { return makeItemHtml(d, d._idx); }).join('') + '</div>' : '';
          document.getElementById('recommendedSection').innerHTML = recHtml;
          document.getElementById('unverifiedSection').innerHTML = unvHtml;
          document.getElementById('scanResults').style.display = 'block';
          var msg = formatMsg(t('messages.scanDone'), { count: result.dummies.length });
          if (recommended.length > 0 && unverified.length > 0) msg += formatMsg(t('messages.scanWithSections'), { rec: recommended.length, unv: unverified.length });
          else if (unverified.length > 0) msg += t('messages.scanUnverifiedHint');
          else msg += t('messages.scanSelectHint');
          document.getElementById('preview').innerText = msg;
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          document.getElementById('preview').innerText = t('messages.errorPrefix') + msg;
        }).scanDummyCitations();
      }

      function escapeHtml(s) {
        if (!s) return '';
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function handleApplyMapping() {
        var preview = document.getElementById('preview');
        try {
          if (!scanData || !scanData.dummies || scanData.dummies.length === 0) {
            preview.innerText = t('messages.mappingApplyFirst');
            return;
          }
          var mappings = [];
          for (var i = 0; i < scanData.dummies.length; i++) {
            var includeCb = document.getElementById('include_' + i);
            if (includeCb && !includeCb.checked) continue;
            var sel = document.getElementById('map_' + i);
            if (!sel) continue;
            var val = sel.value;
            if (val === '-1' || val === 'SKIP') continue;
            var idx = parseInt(val, 10);
            if (isNaN(idx) || idx < 0 || idx >= citationListData.length) continue;
            mappings.push({ dummyText: scanData.dummies[i].text, realData: citationListData[idx] });
          }
          if (mappings.length === 0) {
            preview.innerText = t('messages.mappingSelectItems');
            return;
          }
          preview.innerText = t('messages.applying');
          google.script.run
            .withSuccessHandler(function(result) {
              try {
                result = (typeof result === 'string') ? JSON.parse(result) : result;
              } catch (e) {
                result = {};
              }
              if (result && result.error) {
                preview.innerText = t('messages.errorPrefix') + result.error;
                return;
              }
              var count = (result && result.replaced != null) ? result.replaced : 0;
              preview.innerText = formatMsg(t('messages.mappingDone'), { count: count });
              document.getElementById('scanResults').style.display = 'none';
              scanData = null;
            })
            .withFailureHandler(function(err) {
              var msg = (err && (err.message || err.error || err)) || String(err);
              preview.innerText = t('messages.errorPrefix') + (msg || t('errors.operationFailed'));
            })
            .applyMapping(mappings);
        } catch (e) {
          var msg = (e && e.message) ? e.message : String(e);
          preview.innerText = t('messages.errorPrefix') + msg;
        }
      }

      function handleFinalize() {
        var preview = document.getElementById('preview');
        preview.innerText = t('messages.finalizing');
        google.script.run
          .withSuccessHandler(function(count) {
            var msg = formatMsg(t('messages.finalizeDone'), { count: count != null ? count : 0 });
            preview.innerText = msg;
            alert(msg);
          })
          .withFailureHandler(function(err) {
            var msg = (err && (err.message || err.error || err)) || String(err);
            preview.innerText = t('messages.errorPrefix') + msg;
            alert(t('messages.errorPrefix') + msg);
          })
          .finalizeCitations();
      }

      function handleSort() {
        var preview = document.getElementById('preview');
        preview.className = '';
        preview.innerText = t('messages.sorting');
        google.script.run
          .withSuccessHandler(function(result) {
            try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
            if (result && result.ok) {
              var msg = (result.message != null && result.message !== '') ? result.message : t('messages.sortDone');
              preview.innerText = msg;
              alert(msg);
            } else {
              preview.className = 'preview-error';
              preview.innerText = result && result.error ? (t('messages.errorPrefix') + result.error) : t('messages.errorPrefix') + 'Unknown error';
              alert(preview.innerText);
            }
          })
          .withFailureHandler(function(err) {
            var msg = (err && (err.message || err.error || err)) || String(err);
            preview.className = 'preview-error';
            preview.innerText = t('messages.errorPrefix') + msg;
            alert(preview.innerText);
          })
          .sortAndFormatBibliography();
      }
    </script>
  </body>
</html>