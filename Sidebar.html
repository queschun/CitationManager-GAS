<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Malgun Gothic', sans-serif; padding: 15px; color: #333; font-size: 13px; }
      .input-group { margin-bottom: 10px; }
      label { display: block; margin-bottom: 3px; font-weight: bold; }
      input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
      .btn { width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
      .btn-blue { background-color: #1a73e8; }
      .btn-gray { background-color: #5f6368; }
      .btn-green { background-color: #34a853; }
      .btn-red { background-color: #d93025; margin-top: 20px; }
      .tab-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
      .tab { padding: 8px 15px; cursor: pointer; border-bottom: 2px solid transparent; }
      .tab.active { border-bottom: 2px solid #1a73e8; font-weight: bold; color: #1a73e8; }
      #preview { margin-top:15px; padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 20px; font-size: 11px; }
    </style>
  </head>
  <body>
    <div class="tab-container">
      <div id="tab1" class="tab active" onclick="switchTab(1)">직접 입력</div>
      <div id="tab2" class="tab" onclick="switchTab(2)">통째로 붙여넣기</div>
    </div>

    <div id="manualEntry">
      <div class="input-group">
        <label>논문/도서 제목</label>
        <input type="text" id="title" placeholder="제목을 입력하세요">
      </div>
      <div class="input-group">
        <label>저자 (세미콜론 ';'으로 구분)</label>
        <input type="text" id="author" placeholder="Li, A; Smith, B">
      </div>
      <div class="input-group">
        <label>출판사 / 학회</label>
        <input type="text" id="publisher" placeholder="출판 정보">
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>연도</label>
          <input type="text" id="year" placeholder="2024">
        </div>
        <div style="flex: 1;">
          <label>양식</label>
          <select id="style">
            <option value="APA">APA</option>
            <option value="MLA">MLA</option>
          </select>
        </div>
      </div>
    </div>

    <div id="pasteEntry" style="display: none;">
      <div class="input-group">
        <label>본문에 삽입할 문구 (Short)</label>
        <input type="text" id="shortCit" placeholder="예: (Smith, 2024)">
      </div>
      <div class="input-group">
        <label>전체 참고문헌 정보 (Full)</label>
        <textarea id="fullPaste" rows="5" placeholder="전체 내용을 붙여넣으세요."></textarea>
      </div>
    </div>

    <p style="font-size: 11px; color: #666; margin: 8px 0 0 0;">삽입 위치: 본문에서 원하는 곳을 클릭한 뒤 버튼을 누르세요.</p>
    <div style="display: flex; gap: 5px; margin-top: 10px;">
      <button class="btn btn-blue" onclick="handleEntry('insert')" style="flex: 2;">본문에 삽입 및 저장</button>
      <button class="btn btn-gray" onclick="handleEntry('save')" style="flex: 1;">저장만 하기</button>
    </div>
    <button class="btn btn-green" onclick="handleGenerate()">참고문헌 목록 생성</button>
    <button class="btn btn-red" onclick="handleClear()">데이터 전체 초기화</button>
    
    <p style="font-size: 10px; color: #888; margin-top: 8px;">처음 사용 시 &#39;권한 허용&#39; 창이 뜨면 허용해 주세요.</p>
    <div id="preview">알림: 대기 중...</div>

    <script>
      function switchTab(num) {
        document.getElementById('manualEntry').style.display = num === 1 ? 'block' : 'none';
        document.getElementById('pasteEntry').style.display = num === 2 ? 'block' : 'none';
        document.getElementById('tab1').className = num === 1 ? 'tab active' : 'tab';
        document.getElementById('tab2').className = num === 2 ? 'tab active' : 'tab';
      }

      function formatAuthors(str) {
        const authors = str.split(';').map(s => s.trim()).filter(s => s !== "");
        if (authors.length === 0) return "Unknown";
        if (authors.length === 1) return authors[0];
        if (authors.length === 2) return authors[0] + " & " + authors[1];
        return authors[0] + " et al.";
      }

      function handleEntry(action) {
        const isManual = document.getElementById('manualEntry').style.display !== 'none';
        const preview = document.getElementById('preview');
        let data = {};

        if (isManual) {
          const title = document.getElementById('title').value;
          const authorInput = document.getElementById('author').value;
          const year = document.getElementById('year').value;
          const publisher = document.getElementById('publisher').value;
          const style = document.getElementById('style').value;

          if (!title || !authorInput || !year) { alert("필수 정보를 입력하세요."); return; }
          const formattedAuthor = formatAuthors(authorInput);
          data = {
            mode: 'manual', title: title, author: formattedAuthor, secondVal: year,
            publisher: publisher, style: style,
            fullText: style === 'APA' ? "(" + formattedAuthor + ", " + year + ")" : "(" + formattedAuthor + " " + year + ")"
          };
        } else {
          const shortCit = document.getElementById('shortCit').value;
          const fullText = document.getElementById('fullPaste').value;
          if (!shortCit || !fullText) { alert("데이터를 모두 입력하세요."); return; }
          data = { mode: 'paste', fullText: fullText.trim(), shortText: shortCit.trim(), title: "Pasted_" + new Date().getTime() };
        }

        preview.innerText = "⏳ 처리 중...";
        var runner = google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            preview.innerText = "❌ 오류: " + result.error;
            return;
          }
          if (action === 'insert') {
            if (result && result.at === 'cursor') preview.innerText = "✅ 커서(선택) 위치에 삽입 및 저장 완료!";
            else preview.innerText = "✅ 본문 맨 끝에 삽입 및 저장 완료. 문서 맨 아래를 확인하세요.";
          } else {
            preview.innerText = "✅ 저장 완료!";
          }
          if (isManual) { document.getElementById('title').value = ""; document.getElementById('author').value = ""; document.getElementById('year').value = ""; document.getElementById('publisher').value = ""; }
          else { document.getElementById('shortCit').value = ""; document.getElementById('fullPaste').value = ""; }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          preview.innerText = "❌ 오류(서버 연결): " + msg;
        });
        if (action === 'insert') runner.insertCitation(data);
        else runner.saveCitationOnly(data);
      }

      function handleGenerate() {
        document.getElementById('preview').innerText = "⏳ 목록 생성 중...";
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.ok && result.count > 0) {
            document.getElementById('preview').innerText = "✅ 참고문헌 " + result.count + "개 생성 완료! (마지막 페이지)";
          } else if (result && result.message) {
            document.getElementById('preview').innerText = "⚠️ " + result.message + " 먼저 '저장만 하기' 또는 '본문에 삽입 및 저장'으로 항목을 추가하세요.";
          } else {
            document.getElementById('preview').innerText = "⚠️ 저장된 참고문헌이 없습니다. 먼저 항목을 추가하세요.";
          }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          document.getElementById('preview').innerText = "❌ 오류: " + msg;
        }).generateBibliography();
      }

      function handleClear() {
        if (confirm("모든 데이터를 삭제하시겠습니까?")) {
          google.script.run.withSuccessHandler(() => {
            alert("초기화되었습니다.");
            document.getElementById('preview').innerText = "✅ 초기화 완료";
          }).withFailureHandler(function(err) {
            var msg = (err && (err.message || err.error || err)) || String(err);
            document.getElementById('preview').innerText = "❌ 오류: " + msg;
          }).clearCitations();
        }
      }
    </script>
  </body>
</html>