<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Malgun Gothic', sans-serif; padding: 12px; color: #333; font-size: 12px; max-width: 300px; box-sizing: border-box; }
      * { box-sizing: border-box; }
      .input-group { margin-bottom: 8px; }
      label { display: block; margin-bottom: 2px; font-weight: bold; font-size: 12px; }
      input, select, textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
      .btn { width: 100%; padding: 8px 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 4px; font-size: 12px; }
      .btn-blue { background-color: #1a73e8; }
      .btn-gray { background-color: #5f6368; }
      .btn-green { background-color: #34a853; }
      .btn-red { background-color: #d93025; margin-top: 16px; }
      .tab-container { display: flex; margin-bottom: 12px; border-bottom: 1px solid #ddd; gap: 8px; }
      .tab { padding: 6px 12px; cursor: pointer; border-bottom: 2px solid transparent; font-size: 12px; }
      .tab.active { border-bottom: 2px solid #1a73e8; font-weight: bold; color: #1a73e8; }
      #preview { margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; min-height: 18px; font-size: 12px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; }
      #preview.preview-error { color: #d93025; }
      /* 인용 검사 리스트 박스 크기 확대 */
      .scan-list-box {
        max-height: 400px !important; /* 300px에서 400px로 확대 */
        min-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 6px;
        background: #fafafa;
        margin-bottom: 12px;
      }
      .scan-list-box.section-unverified { background: #fff8f8; border-color: #e0e0e0; }
      .dummy-item { margin-bottom: 2px; padding: 2px 4px; background: white; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 11px; line-height: 1.3; min-height: 0; }
      .dummy-item .dummy-text { font-weight: bold; color: #1a73e8; margin-bottom: 2px; font-size: 11px; }
      .dummy-item .score-tag { font-size: 10px; color: #666; font-weight: normal; margin-left: 4px; }
      .section-title { font-size: 12px; font-weight: bold; margin: 8px 0 4px 0; color: #333; }
      .section-unverified .section-title { color: #d93025; }
      .warn-tag { font-size: 10px; color: #d93025; background: #fce8e6; padding: 2px 6px; border-radius: 3px; margin-left: 6px; }
      .dummy-item select { margin-top: 2px; font-size: 11px; padding: 2px 4px; width: 100%; min-height: 26px; }
      /* 서식 설정 탭의 체크박스 행 개선 */
      .checkbox-row {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        gap: 8px !important;
        margin-bottom: 10px !important;
        width: 100% !important;
        white-space: normal !important; /* 텍스트가 너무 길면 다음 줄로 자연스럽게 넘어가게 함 */
      }

      .checkbox-row input[type="checkbox"] {
        flex-shrink: 0 !important; /* 체크박스 크기 고정 */
        width: 16px !important;
        height: 16px !important;
      }

      .checkbox-row label {
        font-size: 12px !important;
        line-height: 1.2 !important;
        cursor: pointer;
        flex: 1; /* 남은 공간 차지 */
        overflow: visible !important; /* 텍스트가 잘리지 않게 함 */
      }
      select { width: 100%; min-width: 0; min-height: 32px; padding: 6px 24px 6px 8px; appearance: auto; font-size: 12px; }
      #styleEntry .input-group { min-width: 0; }
      #styleEntry select { width: 100%; box-sizing: border-box; }
      /* 페이지 라벨 한 줄: 라벨 좌측, p./pp. 토글 우측 */
      .page-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .page-label-row > label {
        margin-bottom: 0;
      }

      .page-toggle-inline {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .page-toggle-inline input[type="checkbox"] {
        width: 13px;
        height: 13px;
        margin: 0;
        flex-shrink: 0;
      }

      .page-toggle-inline label {
        margin: 0;
        font-size: 11px;
        font-weight: normal;
        white-space: nowrap;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="tab-container">
      <div id="tab1" class="tab active" onclick="switchTab(1)">직접 입력</div>
      <div id="tab2" class="tab" onclick="switchTab(2)">통째로 붙여넣기</div>
      <div id="tab3" class="tab" onclick="switchTab(3)">인용 검사</div>
      <div id="tab4" class="tab" onclick="switchTab(4)">서식 설정</div>
    </div>

    <div id="manualEntry">
      <div class="input-group">
        <label>논문/도서 제목</label>
        <input type="text" id="title" placeholder="제목을 입력하세요">
      </div>
      <div class="input-group">
        <label>저자 (세미콜론 ';'으로 구분)</label>
        <input type="text" id="author" placeholder="Li, A; Smith, B">
      </div>
      <div class="input-group">
        <label>출판사 / 학회 / 저널명</label>
        <input type="text" id="publisher" placeholder="출판 정보">
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>권 (Volume)</label>
          <input type="text" id="volume" placeholder="25">
        </div>
        <div style="flex: 1;">
          <label>호 (Issue)</label>
          <input type="text" id="issue" placeholder="6">
        </div>
      </div>
      <div class="input-group">
        <div class="page-label-row">
          <label for="page">페이지 (Page)</label>
          <span class="page-toggle-inline">
            <input type="checkbox" id="korUsePagePrefixManual">
            <label for="korUsePagePrefixManual">p./pp. 표시</label>
          </span>
        </div>
        <input type="text" id="page" placeholder="10-25 또는 110-120">
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>연도</label>
          <input type="text" id="year" placeholder="2024">
        </div>
        <div style="flex: 1;">
          <label>양식</label>
          <select id="style">
            <option value="APA">APA</option>
            <option value="MLA">MLA</option>
          </select>
        </div>
      </div>
    </div>

    <div id="pasteEntry" style="display: none;">
      <div class="input-group">
        <label for="shortCit">본문 인용구 제안 (수정 가능)</label>
        <input type="text" id="shortCit" placeholder="예: (Smith, 2024) — 분석 버튼으로 자동 생성">
      </div>
      <div class="input-group">
        <label for="fullPaste">전체 참고문헌 정보 (Full)</label>
        <textarea id="fullPaste" rows="5" placeholder="전체 내용을 붙여넣으세요."></textarea>
        <button type="button" class="btn btn-blue" onclick="analyzeCitation()" style="margin-top: 6px;">지능형 분석 및 인용구 생성</button>
      </div>
      <div class="input-group" id="pasteYearWrap">
        <label for="pasteYear">연도 (분석 결과)</label>
        <input type="text" id="pasteYear" placeholder="분석 후 자동 입력" readonly style="background: #f0f0f0;">
      </div>
    </div>

    <div id="styleEntry" style="display: none;">
      <p style="font-size: 11px; color: #666; margin-bottom: 8px;">참고문헌 목록의 학회별 서식(Style Settings)을 설정합니다. DocumentProperties에 저장되어 문서 전체에 즉시 반영됩니다.</p>
      <div class="input-group">
        <label>스타일 프리셋</label>
        <select id="stylePreset" onchange="onStylePresetChange()">
          <option value="APA">APA 7th</option>
          <option value="MLA">MLA</option>
          <option value="Custom">Custom</option>
        </select>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="italicsTitle" checked>
        <label for="italicsTitle">논문/도서 제목 이탤릭체</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="italicsJournal" checked>
        <label for="italicsJournal">저널명 이탤릭체</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="korItalicsJournal">
        <label for="korItalicsJournal">국문 저널명 이탤릭체 (해제 시 국문은 적용 안 함)</label>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>저자 구분자</label>
          <select id="authorSeparator" style="width: 100%;">
            <option value=", ">, (쉼표)</option>
            <option value=" & ">& (앰퍼샌드)</option>
            <option value="; ">; (세미콜론)</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label>et al./외 기준 (인)</label>
          <input type="number" id="etAlThreshold" min="2" max="10" value="3" style="width: 100%;">
        </div>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>줄 간격 (pt)</label>
          <input type="number" id="lineSpacing" min="0" max="36" value="12" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label>매달린 들여쓰기 (pt)</label>
          <input type="number" id="hangingIndent" min="0" max="72" value="20" style="width: 100%;">
        </div>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>첫 줄 들여쓰기 (pt)</label>
          <input type="number" id="indentFirstLine" min="0" max="72" value="0" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label>헤더 글꼴 크기</label>
          <input type="number" id="headerFontSize" min="8" max="24" value="14" style="width: 100%;">
        </div>
      </div>
      <div class="input-group" style="display: flex; gap: 5px;">
        <div style="flex: 1;">
          <label>헤더 정렬</label>
          <select id="headerAlignment" style="width: 100%;">
            <option value="LEFT">왼쪽</option>
            <option value="CENTER">가운데</option>
            <option value="RIGHT">오른쪽</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label>연도 괄호</label>
          <select id="yearBracket" style="width: 100%;">
            <option value="()">( )</option>
            <option value="[]">[ ]</option>
            <option value="none">없음</option>
          </select>
        </div>
      </div>
      <button class="btn btn-blue" onclick="handleSaveStyle()" style="margin-top: 8px;">설정 저장</button>
    </div>

    <div id="scanEntry" style="display: none;">
      <p style="font-size: 11px; color: #666; margin-bottom: 10px;">문서 내 임시 인용 (예: (Kim, 2024), [Kim24])을 감지하고 실제 문헌과 연결합니다.</p>
      <button class="btn btn-blue" onclick="handleScan()" style="margin-bottom: 10px;">문서 스캔</button>
      <div id="scanResults" style="display: none;">
        <div id="recommendedSection" style="margin-bottom: 10px;"></div>
        <div id="unverifiedSection" class="section-unverified" style="margin-bottom: 10px;"></div>
        <button class="btn btn-green" onclick="handleApplyMapping()">매핑 적용</button>
      </div>
    </div>

    <p id="insertHint" style="font-size: 11px; color: #666; margin: 8px 0 0 0;">삽입 위치: 본문에서 원하는 곳을 클릭한 뒤 버튼을 누르세요.</p>
    <div id="entryButtons" style="display: flex; gap: 5px; margin-top: 10px;">
      <button class="btn btn-blue" onclick="handleEntry('insert')" style="flex: 2;">본문에 삽입 및 저장</button>
      <button class="btn btn-gray" onclick="handleEntry('save')" style="flex: 1;">저장만 하기</button>
    </div>
    <button class="btn btn-green" onclick="handleGenerate()">참고문헌 목록 생성</button>
    <button class="btn btn-red" onclick="handleClear()">데이터 전체 초기화</button>
    
    <p style="font-size: 10px; color: #888; margin-top: 8px;">처음 사용 시 &#39;권한 허용&#39; 창이 뜨면 허용해 주세요.</p>
    <div id="preview">알림: 대기 중...</div>

    <script>
      var scanData = null;

      function switchTab(num) {
        document.getElementById('manualEntry').style.display = num === 1 ? 'block' : 'none';
        document.getElementById('pasteEntry').style.display = num === 2 ? 'block' : 'none';
        document.getElementById('scanEntry').style.display = num === 3 ? 'block' : 'none';
        document.getElementById('styleEntry').style.display = num === 4 ? 'block' : 'none';
        document.getElementById('tab1').className = num === 1 ? 'tab active' : 'tab';
        document.getElementById('tab2').className = num === 2 ? 'tab active' : 'tab';
        document.getElementById('tab3').className = num === 3 ? 'tab active' : 'tab';
        document.getElementById('tab4').className = num === 4 ? 'tab active' : 'tab';
        var showEntry = (num === 1 || num === 2);
        document.getElementById('insertHint').style.display = showEntry ? 'block' : 'none';
        document.getElementById('entryButtons').style.display = showEntry ? 'flex' : 'none';
        if (num === 4) loadStyleConfig();
        if (num === 1) loadStyleConfigForManualTab();
      }
      function loadStyleConfigForManualTab() {
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          var c = (result && result.config) || {};
          var el = document.getElementById('korUsePagePrefixManual');
          if (el) el.checked = c.korUsePagePrefix === true;
        }).getStyleConfig();
      }

      function loadStyleConfig() {
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          var c = result.config || {};
          document.getElementById('stylePreset').value = result.preset || 'APA';
          document.getElementById('italicsTitle').checked = c.italicsTitle !== false;
          document.getElementById('italicsJournal').checked = c.italicsJournal !== false;
          document.getElementById('korItalicsJournal').checked = c.korItalicsJournal === true;
          var korManual = document.getElementById('korUsePagePrefixManual');
          if (korManual) korManual.checked = c.korUsePagePrefix === true;
          var sep = c.authorSeparator || ', ';
          document.getElementById('authorSeparator').value = (sep === ' & ') ? ' & ' : (sep === '; ') ? '; ' : ', ';
          document.getElementById('etAlThreshold').value = c.etAlThreshold || 3;
          document.getElementById('lineSpacing').value = c.lineSpacing || 12;
          document.getElementById('hangingIndent').value = c.hangingIndent || 20;
          document.getElementById('indentFirstLine').value = c.indentFirstLine || 0;
          document.getElementById('headerFontSize').value = c.headerFontSize || 14;
          document.getElementById('headerAlignment').value = c.headerAlignment || 'CENTER';
          document.getElementById('yearBracket').value = c.yearBracket || '()';
        }).getStyleConfig();
      }

      function onStylePresetChange() {
        var preset = document.getElementById('stylePreset').value;
        if (preset === 'Custom') return;
        var defs = preset === 'APA'
          ? { italicsTitle: true, italicsJournal: true, yearBracket: '()', authorSeparator: ', ', etAlThreshold: 3, korUsePagePrefix: false, lineSpacing: 12, hangingIndent: 20, indentFirstLine: 0, headerFontSize: 14, headerAlignment: 'CENTER' }
          : { italicsTitle: true, italicsJournal: true, yearBracket: 'none', authorSeparator: ', ', etAlThreshold: 3, korUsePagePrefix: false, lineSpacing: 12, hangingIndent: 20, indentFirstLine: 0, headerFontSize: 14, headerAlignment: 'CENTER' };
        document.getElementById('italicsTitle').checked = defs.italicsTitle;
        document.getElementById('italicsJournal').checked = defs.italicsJournal;
        var korManual = document.getElementById('korUsePagePrefixManual');
        if (korManual) korManual.checked = defs.korUsePagePrefix === true;
        document.getElementById('yearBracket').value = defs.yearBracket;
        document.getElementById('authorSeparator').value = defs.authorSeparator || ', ';
        document.getElementById('etAlThreshold').value = defs.etAlThreshold || 3;
        document.getElementById('lineSpacing').value = defs.lineSpacing;
        document.getElementById('hangingIndent').value = defs.hangingIndent;
        document.getElementById('indentFirstLine').value = defs.indentFirstLine || 0;
        document.getElementById('headerFontSize').value = defs.headerFontSize;
        document.getElementById('headerAlignment').value = defs.headerAlignment || 'CENTER';
      }

      function handleSaveStyle() {
        var preset = document.getElementById('stylePreset').value;
        var config = {
          italicsTitle: document.getElementById('italicsTitle').checked,
          italicsJournal: document.getElementById('italicsJournal').checked,
          korItalicsJournal: document.getElementById('korItalicsJournal').checked,
          korUsePagePrefix: (function(){ var el = document.getElementById('korUsePagePrefixManual'); return el ? el.checked : false; })(),
          authorSeparator: document.getElementById('authorSeparator').value || ', ',
          etAlThreshold: parseInt(document.getElementById('etAlThreshold').value, 10) || 3,
          lineSpacing: parseInt(document.getElementById('lineSpacing').value, 10) || 12,
          hangingIndent: parseInt(document.getElementById('hangingIndent').value, 10) || 20,
          indentFirstLine: parseInt(document.getElementById('indentFirstLine').value, 10) || 0,
          headerFontSize: parseInt(document.getElementById('headerFontSize').value, 10) || 14,
          headerAlignment: document.getElementById('headerAlignment').value || 'CENTER',
          yearBracket: document.getElementById('yearBracket').value || '()'
        };
        document.getElementById('preview').innerText = "⏳ 저장 중...";
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          document.getElementById('preview').innerText = result.error ? "❌ 오류: " + result.error : "✅ 서식 설정이 저장되었습니다. 참고문헌 생성 시 적용됩니다.";
        }).withFailureHandler(function(err) {
          document.getElementById('preview').innerText = "❌ 오류: " + (err && (err.message || err.error || err)) || String(err);
        }).saveStyleConfig({ config: config, preset: preset });
      }

      function formatAuthorsForInText(str) {
        if (!str) return "Unknown";
        
        // 국문 여부 판별
        const isKo = /[\uac00-\ud7a3\u4e00-\u9fff]/.test(str);
        
        // 지능형 구분자 분리: 세미콜론이 있으면 세미콜론 우선, 없으면 쉼표로 분리
        let authors = [];
        if (str.indexOf(';') >= 0) {
          authors = str.split(';').map(s => s.trim()).filter(s => s !== "");
        } else if (isKo) {
          authors = str.split(',').map(s => s.trim()).filter(s => s !== "");
        } else {
          authors = [str.trim()];
        }
        
        if (authors.length === 0) return "Unknown";
        if (authors.length === 1) return authors[0];
        
        // 영문 성(Surname) 추출 함수
        const getSurname = (name) => {
          const n = name.split(' ');
          return n[n.length - 1];
        };

        if (isKo) {
          // 국문: 2명은 'A & B', 3명 이상은 'A 외'
          if (authors.length >= 3) return authors[0] + " 외";
          return authors[0] + " & " + authors[1];
        } else {
          // 영문: 3명 이상 'Surname et al.', 2명 'Surname & Surname'
          if (authors.length >= 3) return getSurname(authors[0]) + " et al.";
          return getSurname(authors[0]) + " & " + getSurname(authors[1]);
        }
      }

      /** 지능형 분석: Code.gs의 parseAndSuggestCitation 호출 후 Short·연도 칸 채움. 실패 시 수동 입력 유도 */
      function analyzeCitation() {
        var fullText = (document.getElementById("fullPaste") && document.getElementById("fullPaste").value || "").trim();
        if (!fullText) {
          alert("전체 참고문헌 정보(Full)를 먼저 붙여넣으세요.");
          return;
        }
        var preview = document.getElementById("preview");
        if (preview) preview.innerText = "⏳ 분석 중...";
        google.script.run
          .withSuccessHandler(function(resultStr) {
            try {
              var result = typeof resultStr === "string" ? JSON.parse(resultStr) : resultStr;
              if (result && result.ok === true) {
                if (document.getElementById("shortCit")) document.getElementById("shortCit").value = result.citationText || "";
                if (document.getElementById("pasteYear")) document.getElementById("pasteYear").value = result.year || "";
                if (preview) preview.innerText = "✅ 분석 완료. 본문 인용구 제안란을 확인·수정 후 저장하세요.";
              } else {
                if (preview) preview.innerText = "⚠️ " + (result && result.error ? result.error : "분석에 실패했습니다. 본문 인용구를 수동으로 입력해 주세요.");
              }
            } catch (e) {
              if (preview) preview.innerText = "⚠️ 결과 처리 중 오류가 발생했습니다. 본문 인용구를 수동으로 입력해 주세요.";
            }
          })
          .withFailureHandler(function(err) {
            var msg = err && (err.message || err.error || err) ? (err.message || err.error || err) : String(err);
            if (preview) preview.innerText = "❌ 서버 오류: " + msg + " 본문 인용구를 수동으로 입력해 주세요.";
          })
          .parseAndSuggestCitation(fullText);
      }

      function handleEntry(action) {
        const isManual = document.getElementById('manualEntry').style.display !== 'none';
        const preview = document.getElementById('preview');
        let data = {};

        if (isManual) {
          const title = document.getElementById('title').value;
          const authorInput = (document.getElementById('author').value || '').trim();
          const year = document.getElementById('year').value;
          const publisher = document.getElementById('publisher').value;
          const volume = (document.getElementById('volume').value || '').trim();
          const issue = (document.getElementById('issue').value || '').trim();
          const page = (document.getElementById('page').value || '').trim();
          const style = document.getElementById('style').value;

          if (!title || !authorInput || !year) { alert("필수 정보를 입력하세요."); return; }
          const formattedAuthor = formatAuthorsForInText(authorInput);
          preview.innerText = "⏳ 처리 중...";
          google.script.run.withSuccessHandler(function(fullText) {
            data = {
              mode: 'manual', title: title, author: formattedAuthor, authorRaw: authorInput, secondVal: year,
              publisher: publisher, volume: volume, issue: issue, page: page, style: style, fullText: fullText,
              korUsePagePrefix: document.getElementById('korUsePagePrefixManual') ? document.getElementById('korUsePagePrefixManual').checked : false
            };
            var runner = google.script.run.withSuccessHandler(function(result) {
              try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
              if (result && result.error) { preview.innerText = "❌ 오류: " + result.error; return; }
              if (action === 'insert') preview.innerText = (result.at === 'cursor') ? "✅ 커서(선택) 위치에 삽입 및 저장 완료!" : "✅ 본문 맨 끝에 삽입 및 저장 완료. 문서 맨 아래를 확인하세요.";
              else preview.innerText = "✅ 저장 완료!";
              document.getElementById('title').value = ""; document.getElementById('author').value = ""; document.getElementById('year').value = "";
              document.getElementById('publisher').value = ""; document.getElementById('volume').value = ""; document.getElementById('issue').value = ""; document.getElementById('page').value = "";
            }).withFailureHandler(function(err) {
              var msg = (err && (err.message || err.error || err)) || String(err);
              preview.innerText = "❌ 오류(서버 연결): " + msg;
            });
            if (action === 'insert') runner.insertCitation(data); else runner.saveCitationOnly(data);
          }).withFailureHandler(function(err) {
            preview.innerText = "❌ 오류: " + (err && (err.message || err.error || err)) || String(err);
          }).getInTextCitationString(authorInput, year, style);
          return;
        } else {
          const shortCit = document.getElementById('shortCit').value;
          const fullText = document.getElementById('fullPaste').value;
          if (!shortCit || !fullText) { alert("데이터를 모두 입력하세요."); return; }
          data = { mode: 'paste', fullText: fullText.trim(), shortText: shortCit.trim(), title: "Pasted_" + new Date().getTime() };
        }

        preview.innerText = "⏳ 처리 중...";
        var runner = google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            preview.innerText = "❌ 오류: " + result.error;
            return;
          }
          if (action === 'insert') {
            if (result && result.at === 'cursor') preview.innerText = "✅ 커서(선택) 위치에 삽입 및 저장 완료!";
            else preview.innerText = "✅ 본문 맨 끝에 삽입 및 저장 완료. 문서 맨 아래를 확인하세요.";
          } else {
            preview.innerText = "✅ 저장 완료!";
          }
          if (isManual) {
            document.getElementById('title').value = "";
            document.getElementById('author').value = "";
            document.getElementById('year').value = "";
            document.getElementById('publisher').value = "";
            document.getElementById('volume').value = "";
            document.getElementById('issue').value = "";
            document.getElementById('page').value = "";
          }
          else {
            document.getElementById('shortCit').value = "";
            document.getElementById('fullPaste').value = "";
            if (document.getElementById('pasteYear')) document.getElementById('pasteYear').value = "";
          }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          preview.innerText = "❌ 오류(서버 연결): " + msg;
        });
        if (action === 'insert') runner.insertCitation(data);
        else runner.saveCitationOnly(data);
      }

      function handleGenerate() {
        var preview = document.getElementById('preview');
        preview.className = '';
        preview.innerText = "⏳ 목록 생성 중...";
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.ok && result.count > 0) {
            preview.className = '';
            preview.innerText = "✅ 참고문헌 " + result.count + "개 생성 완료! (마지막 페이지)";
          } else if (result && result.error) {
            preview.className = 'preview-error';
            preview.innerText = "❌ 오류: " + result.error;
          } else if (result && result.message) {
            preview.className = '';
            preview.innerText = "⚠️ " + result.message + " 먼저 '저장만 하기' 또는 '본문에 삽입 및 저장'으로 항목을 추가하세요.";
          } else {
            preview.className = '';
            preview.innerText = "⚠️ 저장된 참고문헌이 없습니다. 먼저 항목을 추가하세요.";
          }
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          preview.className = 'preview-error';
          preview.innerText = "❌ 오류: " + msg;
        }).generateBibliography();
      }

      function handleClear() {
        if (confirm("모든 데이터를 삭제하시겠습니까?")) {
          google.script.run.withSuccessHandler(function() {
            alert("초기화되었습니다.");
            document.getElementById('preview').innerText = "✅ 초기화 완료";
            scanData = null;
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('recommendedSection').innerHTML = '';
            document.getElementById('unverifiedSection').innerHTML = '';
          }).withFailureHandler(function(err) {
            var msg = (err && (err.message || err.error || err)) || String(err);
            document.getElementById('preview').innerText = "❌ 오류: " + msg;
          }).clearCitations();
        }
      }

      function handleScan() {
        document.getElementById('preview').innerText = "⏳ 문서 스캔 중...";
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            document.getElementById('preview').innerText = "❌ 오류: " + result.error;
            return;
          }
          scanData = result;
          if (!result.dummies || result.dummies.length === 0) {
            document.getElementById('preview').innerText = "⚠️ 감지된 임시 인용이 없습니다.";
            document.getElementById('scanResults').style.display = 'none';
            return;
          }
          var opts = result.citationOptions || [];
          if (opts.length === 0) {
            document.getElementById('preview').innerText = "⚠️ 저장된 문헌이 없습니다. 먼저 '직접 입력' 또는 '통째로 붙여넣기'로 문헌을 추가하세요.";
            document.getElementById('scanResults').style.display = 'none';
            return;
          }
          var recommended = [];
          var unverified = [];
          for (var i = 0; i < result.dummies.length; i++) {
            var d = result.dummies[i];
            d._idx = i;
            if (d.isUnverified) unverified.push(d);
            else recommended.push(d);
          }
          var makeItemHtml = function(d, idx) {
            var recIdx = d.recommendedIndex !== undefined ? d.recommendedIndex : (d.suggestedIndex !== undefined ? d.suggestedIndex : -1);
            var score = d.score !== undefined ? d.score : 0;
            var sel = '<select id="map_' + idx + '" class="citation-select">';
            sel += '<option value="-1">대체하지 않음(Skip)</option>';
            for (var j = 0; j < opts.length; j++) {
              var selected = (recIdx >= 0 && opts[j].index === recIdx) ? ' selected' : '';
              sel += '<option value="' + opts[j].index + '"' + selected + '>' + escapeHtml(opts[j].label || '') + '</option>';
            }
            sel += '</select>';
            var warnTag = d.isUnverified ? '<span class="warn-tag">⚠ 문헌 연결 필요</span>' : '';
            var scoreTag = (score > 0 && !d.isUnverified) ? ' <span class="score-tag">' + score + '점</span>' : '';
            return '<div class="dummy-item" data-index="' + idx + '"><div class="dummy-text">' + escapeHtml(d.text) + scoreTag + warnTag + '</div>' + sel + '</div>';
          };
          var recHtml = recommended.length > 0 ? '<div class="section-title">추천된 항목 (' + recommended.length + ')</div><div class="scan-list-box">' + recommended.map(function(d) { return makeItemHtml(d, d._idx); }).join('') + '</div>' : '';
          var unvHtml = unverified.length > 0 ? '<div class="section-title">미확인 항목 (' + unverified.length + ')</div><div class="scan-list-box section-unverified">' + unverified.map(function(d) { return makeItemHtml(d, d._idx); }).join('') + '</div>' : '';
          document.getElementById('recommendedSection').innerHTML = recHtml;
          document.getElementById('unverifiedSection').innerHTML = unvHtml;
          document.getElementById('scanResults').style.display = 'block';
          var msg = "✅ " + result.dummies.length + "개 인용 후보 감지됨";
          if (recommended.length > 0 && unverified.length > 0) msg += " (추천 " + recommended.length + " / 미확인 " + unverified.length + ")";
          else if (unverified.length > 0) msg += ". 미확인 항목에 문헌을 연결해 주세요.";
          else msg += ". 문헌을 선택하고 '매핑 적용'을 누르세요.";
          document.getElementById('preview').innerText = msg;
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          document.getElementById('preview').innerText = "❌ 오류: " + msg;
        }).scanDummyCitations();
      }

      function escapeHtml(s) {
        if (!s) return '';
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function handleApplyMapping() {
        if (!scanData || !scanData.dummies || scanData.dummies.length === 0) {
          document.getElementById('preview').innerText = "⚠️ 먼저 '문서 스캔'을 실행하세요.";
          return;
        }
        var mappings = [];
        for (var i = 0; i < scanData.dummies.length; i++) {
          var sel = document.getElementById('map_' + i);
          if (!sel) continue;
          var val = sel.value;
          if (val === '-1' || val === 'SKIP') continue;
          var idx = parseInt(val, 10);
          if (isNaN(idx) || idx < 0) continue;
          mappings.push({ dummyText: scanData.dummies[i].text, citationIndex: idx });
        }
        if (mappings.length === 0) {
          document.getElementById('preview').innerText = "⚠️ 매핑할 항목을 선택해 주세요.";
          return;
        }
        document.getElementById('preview').innerText = "⏳ 치환 적용 중...";
        google.script.run.withSuccessHandler(function(result) {
          try { result = (typeof result === 'string') ? JSON.parse(result) : result; } catch (e) { result = {}; }
          if (result && result.error) {
            document.getElementById('preview').innerText = "❌ 오류: " + result.error;
            return;
          }
          document.getElementById('preview').innerText = "✅ " + (result.replaced || 0) + "개 치환 완료! 참고문헌 목록 생성 시 반영됩니다.";
          document.getElementById('scanResults').style.display = 'none';
          scanData = null;
        }).withFailureHandler(function(err) {
          var msg = (err && (err.message || err.error || err)) || String(err);
          document.getElementById('preview').innerText = "❌ 오류: " + msg;
        }).applyMapping(mappings);
      }
    </script>
  </body>
</html>